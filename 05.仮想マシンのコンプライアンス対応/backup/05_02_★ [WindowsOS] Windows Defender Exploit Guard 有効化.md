# ★ [WindowsOS] Windows Defender Exploit Guard 有効化

Windows OS の堅牢化機能のひとつである Windows Defender Exploit Guard 機能を有効化します。

- 厳密には、この機能の有効化は GC CSB で定義されているわけではなく、MDfC セキュリティポリシーの一つとして定められ、CSB とは別の GC のルールの一つ（WindowsDefenderExploitGuard）として扱われます。このルールには自動是正ロジックが実装されていないため、手作業で機能を有効化します。
- VM にログインして有効化コマンドを入力するのは大変なため、runCommand API を利用して外部から有効化コマンドを与えて実行させます。

なお、直前のゲストアカウントリネームの処理から時間をおかずにこのスクリプトを実行した場合、リネームの処理が未了のためにエラー（Conflict エラー）が出る場合があります。この場合は時間をおいてから本スクリプトを再実行してください。

```bash

for TEMP_SUBSCRIPTION_ID in $TEMP_TARGET_SUBSCRIPTION_IDS; do
az account set -s "${TEMP_SUBSCRIPTION_ID}"

for i in ${VDC_NUMBERS}; do
TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}

# 当該リージョンのリソースグループを拾って処理
for TEMP_RG_NAME in $(az group list --query "[?location == '${TEMP_LOCATION_NAME}' ].name" -o tsv); do

for TEMP_VM_NAME in $(az vm list --resource-group ${TEMP_RG_NAME} --query "[?storageProfile.osDisk.osType=='Windows'].name" -o tsv); do
TEMP_RESOURCE_ID=$(az vm show --resource-group ${TEMP_RG_NAME} --name ${TEMP_VM_NAME} --query id -o tsv)

echo "Enabling Windows Defender Exploit Guard in ${TEMP_VM_NAME}..."
az rest --method post --url "https://management.azure.com${TEMP_RESOURCE_ID}/runCommand?api-version=2018-04-01" --body "{\"commandId\":\"RunPowerShellScript\",\"script\":[\"Add-MpPreference -AttackSurfaceReductionRules_Ids be9ba2d9-53ea-4cdc-84e5-9b1eeee46550 -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids b2b3f03d-6a65-4f7b-a9c7-1c7ef74a9ba4 -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids 9e6c4e1f-7d60-472f-ba1a-a39ef669e4b2 -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids d4f940ab-401b-4efc-aadc-ad5f3c50688a -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids d3e037e1-3eb8-44c8-a917-57927947596d -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids 5beb7efe-fd9a-4556-801d-275e5ffc04cc -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids 3b576869-a4ec-4529-8536-b80a7769e899 -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids 26190899-1602-49e8-8b27-eb1d0a1ce869 -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids 92e97fa1-2edf-4476-bdd6-9dd0b4dddc7b -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids 7674ba52-37eb-4a4f-a9a1-f0f9a1619a2c -AttackSurfaceReductionRules_Actions Enabled\\r\\nAdd-MpPreference -AttackSurfaceReductionRules_Ids 75668c1f-73b5-4cf0-bb93-3ecf5cb7cc84 -AttackSurfaceReductionRules_Actions Enabled\\r\\nSet-MpPreference -EnableControlledFolderAccess Enabled\\r\\necho done.\"]}"

done # TEMP_VM_NAME
done # TEMP_RG_NAME

done # TEMP_LOCATION
done # TEMP_SUBSCRIPTION

```
